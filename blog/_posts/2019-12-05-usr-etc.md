---
layout: post
title:  "Configuration files in /etc and /usr/etc"
date:   2019-12-05 12:47:00 +0100
author: Thorsten Kukuk
---

## Intro

As some may have already noticed, openSUSE MicroOS introduced a `/usr/etc`
directory and some configuration files are already moved to this
directory.

What is behind it? To understand this better, let's at first look how
configuration files are handled today by RPM:

### RPM and configuration files

RPM has limited support for updating configuration files. In the end
this consist of two simple choices:
 * modified configuration files are moved away during upgrade and the admin has to redo the changes.
 * modfied configuration files are keeped and changes done by the distribution are ignored. In the end this could mean, that the service will not work or could be even insecure!

Both are not really user friendly and will most likely lead to a broken
or insecure service after an upgrade, which requires manual work by the
admin. While this is not that problem for e.g. Desktop systems or simple
server, this can lead to a huge amount of work for big clusters.

There are several alternate solutions for this like Three-Way-Diff or doing
the update interactive, but the first one does not solve the problem if
conflicting changes are done, and the second one is no solution for fully
automatic updates.

### Atomic updates

An atomic update is a kind of update that:

* Is atomic
  * Either fully applied or not at all
  * The update does not influence your running system
* Can be rolled back
  * If the update fails or if the udpate is not compatible, you can quickly restore the situation as it was before the update

With atomic updates, another layer of complexity is added: after an update,
before the reboot, the changes done by the update are not visible. If an admin
changes the configuration files in this time, they will be, depending of how
the atomic update is implemented, most likely lost. Or RPM does not see, that
there are modified versions of the config file (e.g. they are stored in an
overlay filesystem) and thus does not even create \*.rpmsave or \*.rpmnew
files. In this case, it's really complicated for the admin to find out that
there is a new configuration file and what he has to adjust, since the new
file is shadowed by the copy in the overlay filesystem.

## Goal

The goal is to provide a concept working for most packages and their
configuration files, which makes automatic updates much easier and
robust.
The longterm result should be, that no package installs anything in `/etc`,
this directory should only contain host specific configuration files 
created during installation and changes made by the system administrator.

## Requirements for a solution

A new way to store and manage configuration files is needed, which makes
sure that:
* It's visible to the admin that something got updated
* It's visible, which changes the admin made
* Best if the changes could be merged automatically
* There should be only one directory to search below for default configuration files

Another problem is, that we have different kinds of "configuration" files:
1. configuration files for applications
2. configuration files for the system (network, hardware, ...)
3. "databases" like `/etc/rpc`, `/etc/services`, `/etc/protocols`
4. system and user accounts (`/etc/passwd`, `/etc/group`, `/etc/shadow`)

## Solutions

For SUSE/openSUSE the decission was made to use `/usr/etc` as the directory
below `/usr` for the distribution provided configuration files.

### Application configuration files

For application configuration files there is already a good solution used
by systemd, which could be adopted for most applications:
  * `/usr/etc/app.conf` is the distribution provided configuration file.
  * if exists, `/etc/app.conf` replaces `/usr/etc/app.conf`.
  * `/etc/app.conf.d/*.conf` contains snippets overiding single entries from `/usr/etc/app.conf` or `/etc/app.conf`.

The workflow ofr the application to load the configuration file would be:
* Application looks for `/etc/app.conf`.
* If this file does not exist, load `/usr/etc/app.conf`
* Look for overides in `/etc/app.conf.d` and merge them

See https://www.freedesktop.org/software/systemd/man/systemd.unit.html#Examples, "Overriding vendor settings" for more details and examples.
A library which provides a simple interface and does it transparently
for the application is [libeconf](https://github.com/openSUSE/libeconf).

Depending on the configuration file format, this is not useable for all
applications. For this one a solution following the above guidelines as
close as possible needs to be found.

### System configuration files (network, hardware, ...)

As this configuration files are system specific and only created during
or after installation and not provided by the distribution, this files
will stay in `/etc`.

### System databases (rpc,services,protocols)

There are files in `/etc` which are strictly spoken no configuration
files. Like `/etc/rpc`, `/etc/services` and `/etc/protocols`. They are changed
very seldom, but sometimes new system applications or third party software
needs to make additions.
This files will be moved to `/usr/etc` and `/etc/nsswitch.conf` changed to
search at first in `/etc` and afterwards in `/usr/etc`. A glibc NSS plugin
[usrfiles](https://github.com/kubic-project/libnss_usrfiles) will be used
for this. `/etc` will contain only the changes done by the admin and third
party software.

### /etc/passwd, /etc/group and /etc/shadow

There is no solution yet for this configuration files which really solves
the problems. Ideas are welcome!

## Further Documentation

* The original, full proposal with many more ideas and background, why some things are done in this way and not another one: [Atomic Updates and /etc](https://github.com/thkukuk/atomic-updates_and_etc/blob/master/README.md)
* The openSUSE wiki page tracking all changes: [Packaging /usr/etc](https://en.opensuse.org/openSUSE:Packaging_UsrEtc)
